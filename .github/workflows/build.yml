name: Build and Release

permissions:
  contents: write  # Give the workflow permission to create releases

on:
  push:
    branches: 
      - main  # Only trigger on pushes to the "main" branch

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
    - uses: actions/checkout@v3
    - name: Set up compiler
      uses: egor-tensin/setup-gcc@v1
      with:
        gcc-version: '11' 
    - name: Compile
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          gcc -o vtttosrt.exe src/vtttosrt.c 
        else
          gcc -o vtttosrt src/vtttosrt.c
    - uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.os }}-build
        path: vtttosrt* # Upload files matching the pattern

  release: 
    needs: build  # This job depends on the 'build' job
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/download-artifact@v3
      with:
        name: ubuntu-latest-build
        path: artifacts/ubuntu-latest
    - uses: actions/download-artifact@v3
      with:
        name: macos-latest-build
        path: artifacts/macos-latest
    - uses: actions/download-artifact@v3
      with:
        name: windows-latest-build
        path: artifacts/windows-latest
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/ubuntu-latest/vtttosrt
          artifacts/macos-latest/vtttosrt
          artifacts/windows-latest/vtttosrt.exe
        tag_name: v${{ github.sha }}  # Use commit SHA as the tag
        name: Release v${{ github.sha }} 
        body: "Binaries built from commit `${{ github.sha }}`."
